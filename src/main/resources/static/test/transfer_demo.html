<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue模拟转账系统</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href = "./css/transfer_style.css">
</head>
<body>
  <div id="app" class="container">
    <header>
      <h1><i class="fas fa-money-bill-transfer"></i> 模拟转账系统</h1>
      <p class="subtitle">Vue实现的账户管理与转账功能(所有金额为整数)</p>
    </header>
    
    <div class="tabs">
      <div class="tab" :class="{ active: activeTab === 'balance' }" @click="activeTab = 'balance'">
        <i class="fas fa-wallet"></i> 余额查询
      </div>
      <div class="tab" :class="{ active: activeTab === 'transfer' }" @click="activeTab = 'transfer'">
        <i class="fas fa-exchange-alt"></i> 转账功能
      </div>
      <div class="tab" :class="{ active: activeTab === 'history' }" @click="activeTab = 'history'">
        <i class="fas fa-history"></i> 交易记录
      </div>
      <div class="tab" :class="{ active: activeTab === 'create' }" @click="activeTab = 'create'">
        <i class="fas fa-plus-circle"></i> 创建账户
      </div>
    </div>
    
    <!-- 余额查询 -->
    <div class="tab-content" v-if="activeTab === 'balance'">
      <h2 class="card-title">账户余额查询</h2>
      <div class="form-group">
        <label for="balanceAccount">账户ID(从10000开始自增)</label>
        <input type="text" id="balanceAccount" v-model="balanceQuery.accountId" placeholder="请输入账户ID">
        <div class="error-message" v-if="balanceError">{{ balanceError }}</div>
      </div>
      <button class="btn-primary" @click="checkBalance">查询余额</button>
      
      <div v-if="balanceResult" class="account-balance">
        账户余额: ¥{{ balanceResult.balance }}
      </div>
    </div>
    
    <!-- 转账功能 -->
    <div class="tab-content" v-if="activeTab === 'transfer'">
      <h2 class="card-title">转账操作</h2>
      <div class="flex-container">
        <div class="flex-item">
          <div class="form-group">
            <label for="fromAccount">出账账户(ID 从10000开始自增)</label>
            <input type="text" id="fromAccount" v-model="transferData.fromAccount" placeholder="请输入出账户ID">
            <div class="error-message" v-if="transferErrors.fromAccount">{{ transferErrors.fromAccount }}</div>
          </div>
          
          <div class="form-group">
            <label for="toAccount">入账账户(ID 从10000开始自增)</label>
            <input type="text" id="toAccount" v-model="transferData.toAccount" placeholder="请输入账户ID">
            <div class="error-message" v-if="transferErrors.toAccount">{{ transferErrors.toAccount }}</div>
          </div>
          
          <div class="form-group">
            <label for="amount">转账金额 (¥)(整数)</label>
            <input type="number" id="amount" v-model.number="transferData.amount" placeholder="请输入转账金额">
            <div class="error-message" v-if="transferErrors.amount">{{ transferErrors.amount }}</div>
          </div>
          
          <button class="btn-success" @click="transfer">确认转账</button>
          <div class="error-message" v-if="transferErrors.result">{{ transferErrors.result }}</div>
        </div>
        
        <div class="flex-item" v-if="transferResult">
          <div class="transfer-result">
            <h3>转账结果</h3>
            <div class="account-info">
              <span>出账账户:</span> {{ transferResult.fromAccount }}
            </div>
            <div class="account-info">
              <span>入账账户:</span> {{ transferResult.toAccount }}
            </div>
            <div class="account-info">
              <span>转账金额:</span> ¥{{ transferResult.amount }}
            </div>
            <div class="account-info">
              <span>出账账户当前余额:</span> ¥{{ transferResult.fromBalance }}
            </div>
            <div class="account-info">
              <span>入账账户当前余额:</span> ¥{{ transferResult.toBalance }}
            </div>
            <div class="account-info">
              <span>交易时间:</span> {{ transferResult.opTime}}
            </div>
            <div class="account-info">
              <span>交易状态:</span> <span style="color: #2ecc71;">成功</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 交易记录 -->
    <div class="tab-content" v-if="activeTab === 'history'">
      <h2 class="card-title">交易记录查询</h2>
      <div class="form-group">
        <label for="historyAccount">账户ID</label>
        <input type="text" id="historyAccount" v-model="historyQuery.accountId" placeholder="请输入账户ID">
        <div class="error-message" v-if="historyError">{{ historyError }}</div>
      </div>
      
      <div class="form-group">
        <label>记录类型</label>
            <div>
              <select id="all" v-model="historyQuery.type">
                <option value = "all">全部记录</option>
                <option value = "outgoing">出账记录</option>
                <option value = "incoming">入账记录</option>
              </select>
            </div>
      </div>
      
      <button class="btn-primary" @click="getTransactionHistory">查询记录</button>
  
      <div v-if="historyResult.length > 0">
        <table class="transaction-table">
          <thead>
            <tr>
              <th>交易时间</th>
              <th>查询账户</th>
              <th>查询账户余额</th>
              <th>对手账户</th>
              <th>对手账户余额</th>
              <th>金额</th>
              <th>类型</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="transaction in historyResult" :key="transaction.id">
              <td>{{ transaction.opTime }}</td>
              <td>{{ currentQueryAccountID }}</td>
              <td>¥{{ transaction.fromAccount == currentQueryAccountID ? transaction.fromBalance : transaction.toBalance }}</td>
              <td>{{ transaction.fromAccount == currentQueryAccountID ? transaction.toAccount : transaction.fromAccount }}</td>
              <td>¥{{ transaction.fromAccount == currentQueryAccountID ? transaction.toBalance : transaction.fromBalance}}</td>
              <td :class="transaction.fromAccount == currentQueryAccountID ? 'amount-negative' : 'amount-positive'">
                {{ transaction.fromAccount == currentQueryAccountID ? '-' : '+' }}¥{{ transaction.amount }}
              </td>
              <td :class="transaction.fromAccount == currentQueryAccountID ? 'amount-negative' : 'amount-positive'">
                {{ transaction.fromAccount == currentQueryAccountID ? '出账' : '入账' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
    </div>
    
    <!-- 创建账户 -->
    <div class="tab-content" v-if="activeTab === 'create'">
      <h2 class="card-title">创建新账户</h2>
      <div class="form-group">
        <label for="initialBalance">初始金额 (¥)</label>
        <input type="number" id="initialBalance" v-model.number="newAccount.initialBalance" placeholder="请输入初始金额">
        <div class="error-message" v-if="createAccountError">{{ createAccountError }}</div>
      </div>
      <button class="btn-primary" @click="createAccount">创建账户</button>
      
      <div v-if="newAccountResult" class="success-message">
        <p>账户创建成功！</p>
        <p>账户ID: <strong>{{ newAccountResult.accountId }}</strong></p>
        <p>初始余额: <strong>¥{{ newAccountResult.balance }}</strong></p>
      </div>
    </div>
        <div class="footer">
            <p>michaelxu365@gmail.com | 模拟转账</p>
        </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;
    
    createApp({
      setup() {
        // 当前激活的Tab
        const activeTab = ref('balance');
        const wPath = window.document.location.href;
        const baseURL = wPath.substring(0, wPath.indexOf("/test"))
        // 余额查询相关
        const balanceQuery = ref({
          accountId: ''
        });
        
        const balanceError = ref('');
        const balanceResult = ref(null);
        
        // 转账相关
        const transferData = ref({
          fromAccount: '',
          toAccount: '',
          amount: ''
        });
        
        const transferErrors = ref({});
        const transferResult = ref(null);
        
        // 交易记录查询相关
        const historyQuery = ref({
          accountId: '',
          type: 'all'
        });
        
        const historyError = ref('');
        const historyResult = ref([]);
        const currentQueryAccountID = ref(null);

        // 创建账户相关
        const newAccount = ref({
          initialBalance: ''
        });
        
        const createAccountError = ref('');
        const newAccountResult = ref(null);
        
        // 查询余额
        const checkBalance = async () => {
          balanceError.value = '';
          balanceResult.value = null;
          
          if (!balanceQuery.value.accountId) {
            balanceError.value = '请输入账户ID';
            return;
          }
          
          try{
            // 使用axios发送请求
            const response = await axios.get(`${baseURL}/account/${balanceQuery.value.accountId}`);
            if (response.status == 200) {
                if(response.data.code == 0){
                    balanceResult.value = { ...response.data.content};
                } else {
                    balanceError.value = `code:${response.data.code},message:${response.data.message}`;
                }
                return; 
            }
          }catch(error){
            balanceError.value = error;
          }
          balanceError.value = "请求失败";
          return;
          
        };
        
        // 转账操作
        const transfer = async () => {
          // 重置错误和结果
          transferErrors.value = {};
          transferResult.value = null;
          
          // 验证输入
          if (!transferData.value.fromAccount) {
            transferErrors.value.fromAccount = '请选择出账账户';
          }
          
          if (!transferData.value.toAccount) {
            transferErrors.value.toAccount = '请选择入账账户';
          } else if (transferData.value.fromAccount === transferData.value.toAccount) {
            transferErrors.value.toAccount = '出账账户和入账账户不能相同';
          }
          
          if (!transferData.value.amount) {
            transferErrors.value.amount = '请输入转账金额';
          } else if (transferData.value.amount <= 0) {
            transferErrors.value.amount = '转账金额必须大于0';
          }
          
          // 如果有错误，停止执行
          if (Object.keys(transferErrors.value).length > 0) {
            return;
          }
          try{
            // 使用axios发送P请求
            const response = await axios.post(`${baseURL}/transfer`,`{
                        "fromAccount": ${transferData.value.fromAccount},
                        "toAccount": ${transferData.value.toAccount},
                        "amount": ${transferData.value.amount}
                        }`,{"headers":{"Content-type":"application/json"}});  
            if (response.status == 200) {
                if(response.data.code == 0){
                    // 设置转账结果
                    transferResult.value = { ...response.data.content}
                } else {
                    transferErrors.value.result = `code:${response.data.code},message:${response.data.message}`;
                }
                return; 
            }
          }catch(error){
            transferErrors.value.result = error;
          }
          transferErrors.value.result = "请求失败";
          // 重置表单
          transferData.value = {
            fromAccount: '',
            toAccount: '',
            amount: ''
          };
        };
        
        // 查询交易记录
        const getTransactionHistory = async () => {
          historyError.value = '';
          historyResult.value = [];
          currentQueryAccountID.value = historyQuery.value.accountId;
          
          if (!historyQuery.value.accountId) {
            historyError.value = '请输入账户ID';
            return;
          }
          
          path = "transfer"
          // 根据类型过滤交易记录
          if (historyQuery.value.type === 'all') {
            path = `${path}/${historyQuery.value.accountId}`
          } else if (historyQuery.value.type === 'outgoing') {
            path = `${path}/from/${historyQuery.value.accountId}`
          } else if (historyQuery.value.type === 'incoming') {
            path = `${path}/to/${historyQuery.value.accountId}`
          }
          try{
            // 使用axios发送请求
            const response = await axios.get(`${baseURL}/${path}`);
            if (response.status == 200) {
                if(response.data.code == 0){
                    historyResult.value = response.data.content;
                } else {
                    historyError.value = `code:${response.data.code},message:${response.data.message}`;
                }
                return; 
            }
          }catch(error){
            historyError.value = error;
          }
          historyError.value = "请求失败";
          return;
        };
        
        // 创建账户
        const createAccount = async() => {
          createAccountError.value = '';
          newAccountResult.value = null;
          
          if (!newAccount.value.initialBalance) {
            createAccountError.value = '请输入初始金额';
            return;
          }
          
          if (newAccount.value.initialBalance < 0) {
            createAccountError.value = '初始金额不能为负数';
            return;
          }
          
          try{
        // 使用axios发送P请求
        const response = await axios.post(`${baseURL}/account`,`{
                    "balance": ${newAccount.value.initialBalance}
                    }`,{"headers":{"Content-type":"application/json"}});  
        if (response.status == 200) {
            if(response.data.code == 0){
                // 设置转账结果
                newAccountResult.value = {...response.data.content}
            } else {
                transferErrors.value.result = `code:${response.data.code},message:${response.data.message}`;
            }
            return; 
          }
        }catch(error){
            transferErrors.value.result = error;
        }
          newAccountResult.value = "请求失败";
          // 重置表单
          newAccount.value = {
            initialBalance: ''
          };
        };
        
        return {
          activeTab,
          balanceQuery,
          balanceError,
          balanceResult,
          transferData,
          transferErrors,
          transferResult,
          historyQuery,
          historyError,
          historyResult,
          newAccount,
          createAccountError,
          newAccountResult,
          currentQueryAccountID,
          checkBalance,
          transfer,
          getTransactionHistory,
          createAccount
        };
      }
    }).mount('#app');
  </script>
</body>
</html>